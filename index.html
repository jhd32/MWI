
<!DOCTYPE html>
<html>
<head>
    <title>玩家数据可视化</title>
    <!-- 使用国内CDN源 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.min.js"></script>
    <script>
        // 增强型fallback检测
        if(!window.Chart || !window.moment) {
            document.write('<script src="lib/chart.min.js"><\/script>');
            document.write('<script src="lib/moment.min.js"><\/script>');
            document.write('<script src="lib/chartjs-adapter-moment.min.js"><\/script>');
        }
    </script>
    
    <style>
        .control-panel {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        #chartContainer {
            width: 90%;
            margin: 20px auto;
            height: 400px;
        }
        button {
            padding: 5px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <label>选择日期: 
            <input type="date" id="datePicker" min="2025-05-01" max="2025-05-31">
        </label>
        <label>Y轴最小值: <input type="number" id="yMin"></label>
        <label>Y轴最大值: <input type="number" id="yMax"></label>
        <button onclick="updateChart()">更新图表</button>
    </div>
    <div id="chartContainer">
        <canvas id="dataChart"></canvas>
    </div>

    <script>
        // 库加载检查函数
        function checkLibs() {
            if(!window.Chart || !window.moment) {
                throw new Error("核心库加载失败，请检查网络连接或本地库文件");
            }
        }

        let chart;
        const ctx = document.getElementById('dataChart').getContext('2d');
        
        // 初始化图表
        function initChart(data) {
            checkLibs();
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '活跃玩家数',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        pointRadius: 3,
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm',
                                    minute: 'HH:mm'
                                },
                                tooltipFormat: 'HH:mm',
                                unit: 'hour'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 30
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // 更新图表
        async function updateChart() {
            try {
                const date = document.getElementById('datePicker').value;
                const [year, month, day] = date.split('-');
                const filename = `ActivePlayersData_${parseInt(month)}_${parseInt(day)}.json`;
                
                const response = await fetch(`PlayersData/${filename}`);
                if (!response.ok) throw new Error(`数据文件 ${filename} 未找到`);
                
                const rawData = await response.json();
                const chartData = rawData.map(item => ({
                    x: moment(item[0], "YYYY/MM/DD HH:mm:ss"),
                    y: item[1]
                }));

                initChart(chartData);
                applyYAxisRange();
            } catch (error) {
                console.error('Error:', error);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 应用Y轴范围
        function applyYAxisRange() {
            if(!chart) return;
            
            const yMin = document.getElementById('yMin').value;
            const yMax = document.getElementById('yMax').value;
            
            if (yMin) chart.options.scales.y.min = parseFloat(yMin);
            if (yMax) chart.options.scales.y.max = parseFloat(yMax);
            
            chart.update();
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('datePicker').value = '2025-05-21';
            updateChart();
        });
    </script>
</body>
</html>
